# Исправление ошибки регистрации "Database error saving new user"

## Проблема

При регистрации нового пользователя через OAuth возникает ошибка:
```
Database error saving new user
```

Это происходит потому, что триггер `handle_new_user_profile()` падает при попытке создать профиль пользователя.

## Решение

### 1. Применить миграцию в Supabase

Нужно применить новую миграцию, которая исправляет триггер:

1. Откройте Supabase Dashboard
2. Перейдите в **SQL Editor**
3. Откройте файл `supabase/migrations/20260209000001_fix_user_profiles_trigger.sql`
4. Скопируйте содержимое и выполните в SQL Editor

Или используйте Supabase CLI:
```bash
supabase db push
```

### 2. Что исправлено

- ✅ Добавлена проверка существования профиля перед созданием
- ✅ Добавлена обработка ошибок в триггере (не блокирует создание пользователя)
- ✅ Улучшена надежность создания профиля
- ✅ Добавлен fallback в клиентском коде - если триггер не сработал, профиль создается вручную

### 3. Проверка

После применения миграции:

1. Попробуйте зарегистрировать нового пользователя
2. Проверьте консоль браузера - должны быть логи `[Auth]`
3. Если ошибка все еще возникает, проверьте:
   - Логи Supabase (Dashboard → Logs → Database)
   - RLS политики для таблицы `user_profiles`
   - Права доступа функции `handle_new_user_profile()`

### 4. Временное решение

Если миграцию нельзя применить сразу, клиентский код автоматически попытается создать профиль вручную при обнаружении ошибки. Но лучше применить миграцию для полного исправления.

## Дополнительная диагностика

Если проблема сохраняется после применения миграции:

1. Проверьте логи Supabase:
   - Dashboard → Logs → Database
   - Ищите ошибки с префиксом "Failed to create user profile"

2. Проверьте RLS политики:
   ```sql
   SELECT * FROM pg_policies WHERE tablename = 'user_profiles';
   ```

3. Проверьте права функции:
   ```sql
   SELECT proname, prosecdef FROM pg_proc WHERE proname = 'handle_new_user_profile';
   ```

4. Проверьте, что триггер существует:
   ```sql
   SELECT * FROM pg_trigger WHERE tgname = 'on_auth_user_created';
   ```
