# Очистка "мусорных" данных из БД

## Проблема

В базе данных могут накапливаться записи, которые остались от экспериментов и не имеют связи с существующими данными. Эти записи отображаются в интерфейсах (журналах, персональных кабинетах), но не должны там быть.

## Решение

Созданы три инструмента для очистки:

### 1. Отчет о "мусорных" данных (`cleanup_orphaned_data_report.sql`)

**Использование:**
```sql
-- Выполните в Supabase SQL Editor
-- Покажет количество записей, которые будут удалены
```

**Что проверяет:**
- Записи посещаемости (`attendance`) с несуществующими записями (`enrollments`)
- Записи посещаемости с несуществующими групповыми занятиями
- Записи (`enrollments`) с несуществующими студентами или активностями
- Финансовые транзакции с несуществующими связями
- Записи журналов персонала с несуществующими связями
- И другие проблемные записи

### 2. Скрипт очистки (`cleanup_orphaned_data.sql`)

**Использование:**
```sql
-- ВНИМАНИЕ: Перед выполнением сделайте бэкап БД!
-- Выполните в Supabase SQL Editor
-- Удалит все "мусорные" записи
```

**Что удаляет:**
- Все записи, которые ссылаются на несуществующие данные
- Обнуляет `teacher_id` в `enrollments`, если преподаватель не существует

### 3. Автоматическая функция очистки (`supabase/migrations/20260209000000_add_cleanup_orphaned_data_function.sql`)

**Использование:**
```sql
-- Применить миграцию через Supabase CLI или вручную
-- Затем можно вызывать функцию:
SELECT * FROM public.cleanup_orphaned_data();
```

**Преимущества:**
- Возвращает отчет о количестве удаленных записей
- Можно вызывать периодически
- Можно интегрировать в автоматические задачи (cron jobs)

## Рекомендуемый порядок действий

1. **Сделайте бэкап БД** (через Supabase Dashboard → Settings → Database → Backups)

2. **Проверьте, что будет удалено:**
   ```sql
   -- Выполните cleanup_orphaned_data_report.sql
   -- Просмотрите результаты
   ```

3. **Выполните очистку:**
   ```sql
   -- Вариант А: Одноразовая очистка
   -- Выполните cleanup_orphaned_data.sql
   
   -- Вариант Б: Использование функции (после применения миграции)
   SELECT * FROM public.cleanup_orphaned_data();
   ```

4. **Проверьте результаты:**
   - Проверьте интерфейсы приложения
   - Убедитесь, что "мусорные" данные исчезли
   - Проверьте, что нужные данные остались

## Автоматическая очистка (опционально)

После применения миграции можно настроить автоматическую очистку:

### Вариант 1: Через Supabase Edge Functions + Cron

Создайте Edge Function, которая будет вызывать `cleanup_orphaned_data()` по расписанию.

### Вариант 2: Через pg_cron (если доступен)

```sql
-- Очистка каждую неделю в воскресенье в 3:00
SELECT cron.schedule(
    'cleanup-orphaned-data',
    '0 3 * * 0',
    $$SELECT * FROM public.cleanup_orphaned_data();$$
);
```

### Вариант 3: Вручную через интерфейс

Периодически вызывайте функцию через Supabase SQL Editor.

## Что проверяется и очищается

| Таблица | Проверка | Действие |
|--------|----------|----------|
| `attendance` | Несуществующий `enrollment_id` | Удаление |
| `attendance` | Несуществующий `group_lesson_id` | Удаление |
| `enrollments` | Несуществующий `student_id` | Удаление |
| `enrollments` | Несуществующий `activity_id` | Удаление |
| `enrollments` | Несуществующий `teacher_id` | Обнуление |
| `finance_transactions` | Несуществующие связи | Удаление |
| `staff_journal_entries` | Несуществующие связи | Удаление |
| `staff_billing_rules` | Несуществующие связи | Удаление |
| `group_lesson_sessions` | Несуществующий `group_lesson_id` | Удаление |
| `group_lessons` | Несуществующий `activity_id` | Удаление |
| `group_lesson_staff` | Несуществующие связи | Удаление |
| `activity_teacher_history` | Несуществующие связи | Удаление |
| `activity_price_history` | Несуществующий `activity_id` | Удаление |
| `staff_payouts` | Несуществующий `staff_id` | Удаление |

## Безопасность

- ✅ Скрипты используют только `DELETE` и `UPDATE` - безопасные операции
- ✅ Проверяют существование данных перед удалением
- ✅ Не удаляют данные, которые могут быть нужны
- ⚠️ **Всегда делайте бэкап перед выполнением!**

## Примечания

- Скрипты работают с внешними ключами, которые имеют `ON DELETE SET NULL` или `ON DELETE CASCADE`
- Некоторые записи могут иметь `NULL` значения в полях связей - это нормально и не удаляется
- Функция `cleanup_orphaned_data()` использует `SECURITY DEFINER` для выполнения с правами создателя
