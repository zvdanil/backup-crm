# Подробная инструкция: Развертывание Edge Function через Supabase Dashboard

## Шаг 1: Откройте раздел Edge Functions

1. Откройте ваш проект Supabase:
   - Перейдите по ссылке: https://app.supabase.com/project/qtphickigswerhvintvh
   - Или откройте Dashboard и выберите ваш проект

2. В левом меню найдите раздел **"Edge Functions"** (может быть в разделе "Project Settings" или в основном меню)

3. Нажмите на **"Edge Functions"**

## Шаг 2: Создайте новую функцию

1. На странице Edge Functions нажмите кнопку **"Create a new function"** или **"New Function"**
   - Обычно это зеленая кнопка в правом верхнем углу

2. В появившемся диалоге:
   - **Function name:** введите `create-user` (обязательно именно так, без пробелов, с дефисом)
   - Нажмите **"Create"** или **"Continue"**

## Шаг 3: Скопируйте код функции

1. Откройте файл `supabase/functions/create-user/index.ts` в вашем проекте
   - Полный путь: `c:\Users\User\Downloads\crmbackup-cursor\supabase\functions\create-user\index.ts`

2. Выделите весь код в файле (Ctrl+A) и скопируйте (Ctrl+C)

3. В редакторе функции в Supabase Dashboard:
   - Удалите весь код по умолчанию (если есть)
   - Вставьте скопированный код (Ctrl+V)

4. Проверьте, что код вставлен полностью (должно быть около 143 строк)

## Шаг 4: Разверните функцию

1. Нажмите кнопку **"Deploy"** или **"Save"** в правом верхнем углу редактора
   - Обычно это зеленая кнопка

2. Дождитесь завершения развертывания
   - Вы увидите сообщение об успешном развертывании
   - Функция должна появиться в списке функций со статусом "Active"

### ⚠️ Важно: Обновление функции

Если вы уже развернули функцию ранее и получили ошибку CORS:
1. Откройте функцию `create-user` в Dashboard
2. Убедитесь, что код обновлен (должен быть исправлен CORS)
3. Нажмите **"Deploy"** еще раз, чтобы обновить функцию

## Шаг 5: Настройте переменную окружения (Service Role Key)

### 5.1. Найдите Service Role Key

1. В левом меню Supabase Dashboard перейдите в **"Settings"** (шестеренка)
2. Выберите **"API"** в подменю
3. Найдите раздел **"Project API keys"**
4. Найдите ключ **"service_role"** (секретный ключ)
   - ⚠️ **ВНИМАНИЕ:** Это секретный ключ! Не публикуйте его и не делитесь им
   - Скопируйте этот ключ (нажмите на иконку копирования или выделите и скопируйте)

### 5.2. Добавьте секрет в Edge Functions

1. Вернитесь в раздел **"Edge Functions"**
2. Найдите вкладку или раздел **"Settings"** или **"Secrets"**
   - Может быть в верхнем меню или в боковой панели
   - Или нажмите на название функции `create-user` и выберите "Settings"

3. В разделе **"Secrets"** или **"Environment Variables"**:
   - Нажмите **"Add secret"** или **"New secret"**
   - **Name:** введите `SUPABASE_SERVICE_ROLE_KEY` (точно так, большими буквами)
   - **Value:** вставьте скопированный Service Role Key
   - Нажмите **"Save"** или **"Add"**

## Шаг 6: Проверка работы

1. Откройте ваше приложение
2. Войдите как администратор (owner или admin)
3. Перейдите в раздел **"Користувачі"** (Users)
4. Нажмите **"Створити користувача"**
5. Заполните форму и попробуйте создать пользователя

### Если функция работает:
- Пользователь создастся без ошибки rate limit
- Вы увидите сообщение "Користувача створено"

### Если функция не работает:
- Проверьте консоль браузера (F12) на наличие ошибок
- Убедитесь, что:
  - Функция развернута и активна
  - Секрет `SUPABASE_SERVICE_ROLE_KEY` добавлен правильно
  - Вы вошли как owner или admin

## Альтернативный способ: Проверка через Supabase Dashboard

1. В разделе **Edge Functions** найдите функцию `create-user`
2. Нажмите на нее, чтобы открыть детали
3. Перейдите на вкладку **"Logs"** или **"Invoke"**
4. Попробуйте вызвать функцию вручную (если есть такая возможность)

## Возможные проблемы и решения

### Проблема: "Function not found" (404)
**Решение:** Убедитесь, что функция развернута и называется точно `create-user`

### Проблема: "Unauthorized" или "Forbidden"
**Решение:** 
- Проверьте, что вы вошли как owner или admin
- Убедитесь, что Service Role Key добавлен правильно

### Проблема: "Internal server error"
**Решение:**
- Проверьте логи функции в Dashboard
- Убедитесь, что все переменные окружения установлены
- Проверьте, что код функции скопирован полностью

### Проблема: Все еще получаете rate limit ошибку
**Решение:**
- Убедитесь, что функция развернута (проверьте список функций)
- Проверьте, что используется правильный URL функции
- Очистите кэш браузера и попробуйте снова

## Что дальше?

После успешного развертывания:
- ✅ Создание пользователей через админ-панель не будет ограничено rate limits
- ✅ Можно создавать неограниченное количество пользователей
- ✅ Функция автоматически создает профиль с правильными данными

## Откат (если нужно)

Если что-то пошло не так:
1. Удалите функцию в Dashboard (Edge Functions → выберите функцию → Delete)
2. Система автоматически вернется к использованию `signUp()` (с rate limits)

---

**Примечание:** Если у вас возникнут проблемы на любом этапе, проверьте логи функции в Dashboard или обратитесь за помощью.
