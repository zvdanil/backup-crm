# Объяснение функции `recalculate_advance_balance_for_student`

## Назначение

Эта функция нужна для **пересчёта авансового баланса** для существующих начислений, которые были созданы **до** того, как был установлен триггер автоматического списания.

## Когда использовать

1. **После применения миграции** `APPLY_AUTO_CHARGE_SIMPLIFIED.sql` - для пересчёта всех существующих начислений
2. **Если авансовый баланс не уменьшился** после создания начислений (например, если триггер не сработал)
3. **Для исправления** ситуации, когда платёж был внесён, но начисления не были списаны с авансового баланса

## Как работает функция

### Шаг 1: Проверка авансового баланса
```sql
-- Получает текущий авансовый баланс для студента и счёта
-- Если баланса нет или он <= 0, функция возвращает сообщение и завершается
```

### Шаг 2: Поиск последнего платежа
```sql
-- Находит дату последнего платежа (type = 'payment') для этого студента и счёта
-- Если платежей не было, функция завершается
```

### Шаг 3: Подсчёт начислений после последнего платежа
```sql
-- Считает сумму всех income транзакций (начисления), созданных после последнего платежа
-- Считает сумму всех expense транзакций (возвраты), созданных после последнего платежа
-- Вычисляет чистую сумму начислений: income - expense
```

### Шаг 4: Списание с авансового баланса
```sql
-- Если есть начисления (charge_amount > 0):
--   Списывает с авансового баланса либо всю сумму начислений,
--   либо весь авансовый баланс (что меньше)
--   Например: если начисления = 5000, а аванс = 3000, спишется 3000
```

### Шаг 5: Возврат результата
Функция возвращает JSON с информацией:
- `advance_balance_before` - авансовый баланс до пересчёта
- `advance_balance_after` - авансовый баланс после пересчёта
- `total_income` - сумма всех income транзакций после последнего платежа
- `total_expense` - сумма всех expense транзакций после последнего платежа
- `charge_amount` - чистая сумма начислений (income - expense)
- `charged_from_advance` - сколько было списано с авансового баланса

## Как вызвать функцию

### Вариант 1: В Supabase SQL Editor

```sql
-- Сначала найдите student_id и account_id
-- Например, для студента "Аннемков Максим" и счёта "ТОВ":

-- 1. Найти student_id
SELECT id, full_name FROM students WHERE full_name LIKE '%Аннемков%';

-- 2. Найти account_id для "ТОВ"
SELECT id, name FROM payment_accounts WHERE name = 'ТОВ';

-- 3. Вызвать функцию (замените UUID на реальные значения)
SELECT public.recalculate_advance_balance_for_student(
  'student_id_здесь'::UUID,
  'account_id_здесь'::UUID
);
```

### Вариант 2: Автоматический поиск по имени

```sql
-- Для студента "Аннемков Максим" и счёта "ТОВ"
SELECT public.recalculate_advance_balance_for_student(
  (SELECT id FROM students WHERE full_name LIKE '%Аннемков Максим%' LIMIT 1),
  (SELECT id FROM payment_accounts WHERE name = 'ТОВ' LIMIT 1)
);
```

## Пример результата

```json
{
  "message": "Advance balance recalculated",
  "advance_balance_before": 27240.00,
  "advance_balance_after": 2830.00,
  "total_income": 24410.00,
  "total_expense": 3780.00,
  "charge_amount": 20630.00,
  "charged_from_advance": 24410.00
}
```

**Расшифровка:**
- Было авансового баланса: 27 240 ₴
- Начислений (income): 24 410 ₴
- Возвратов (expense): 3 780 ₴
- Чистые начисления: 24 410 - 3 780 = 20 630 ₴
- Списалось с аванса: 24 410 ₴ (вся сумма начислений, т.к. она меньше аванса)
- Осталось авансового баланса: 27 240 - 24 410 = 2 830 ₴

## Важные замечания

1. **Функция работает только с начислениями ПОСЛЕ последнего платежа** - это сделано для того, чтобы не списывать начисления, которые были созданы до внесения платежа
2. **Функция не создаёт транзакции** - она только уменьшает авансовый баланс
3. **После применения миграции** триггер будет автоматически списывать с авансового баланса все новые начисления
4. **Для старых начислений** нужно вызвать эту функцию вручную

## Когда НЕ нужно вызывать функцию

- Если все начисления были созданы **после** применения миграции (триггер уже их обработал)
- Если авансового баланса нет или он равен 0
- Если платежей для этого студента и счёта не было
