# Инструкция по применению новой версии distribute_advance_payment

## Что изменилось

**Старая логика (неправильная):**
- Считала долги за ВСЁ ВРЕМЯ (все исторические транзакции)
- Сортировала по остатку долга
- Из-за старых переплат "забывала" текущие долги

**Новая логика (правильная):**
- Считает долги **только за месяц платежа** (как UI)
- Сортирует по **начислению (charges)** от большего к меньшему
- Гасит долги последовательно: сначала полностью наибольший, потом следующий

## Как применить

1. Открой **Supabase Dashboard → SQL Editor**
2. Скопируй **весь** файл `APPLY_DISTRIBUTE_FIX_V3_MONTHLY.sql`
3. Выполни одним запросом
4. Готово!

## Тестирование

После применения протестируй сценарий:

1. **Логопед**: начисление 3500, первая оплата 2000
   - Ожидаемый результат: долг Логопеда = 1500, остальные активности без изменений

2. **Вторая оплата**: 800
   - Ожидаемый результат: система должна снова начать с **Логопеда** и погасить оставшийся долг 1500 (полностью, если хватает средств)

3. **Третья оплата**: если остались другие активности с долгами
   - Ожидаемый результат: система должна перейти к следующей активности по начислению

## Важно

- Функция теперь работает **только с месячными данными** (как UI)
- Старые переплаты из других месяцев **не влияют** на текущий расчёт
- При каждом платеже система **заново** находит активность с наибольшим начислением и гасит её долг

## Если что-то не работает

Если после применения логика всё ещё работает неправильно:

1. Выполни диагностический скрипт `DEBUG_DISTRIBUTION_LOGIC.sql` (обновлённая версия)
2. Проверь, что функция видит правильные данные за месяц
3. Убедись, что `account_id` совпадает для всех транзакций
