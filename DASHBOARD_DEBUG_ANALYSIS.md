# Анализ проблемы обновления данных в дашборде

## Проблема
После добавления отметки в журнале посещения данные не появляются в дашборде.

## Цепочка обновления данных

### 1. Создание/обновление attendance
**Файл:** `src/hooks/useAttendance.ts` → `useSetAttendance`
- Вызывается `setAttendance.mutateAsync()`
- Данные сохраняются в БД через Supabase
- В `onSuccess` вызываются:
  - `invalidateQueries(['attendance'])`
  - `invalidateQueries(['dashboard'], exact: false)`
  - `invalidateQueries(['student_activity_balance'])`
  - `refetchQueries(['dashboard'], exact: false)`

### 2. Запрос данных дашборда
**Файл:** `src/hooks/useDashboardData.ts` → `useDashboardData`
- Query key: `['dashboard', 'full', year, month]`
- Запрашивает данные из БД:
  - `enrollments` (без фильтрации по датам)
  - `attendance` (с фильтрацией `.gte('date', startDate).lte('date', endDate)`)
  - `staff_journal_entries` (с фильтрацией по датам)
  - `finance_transactions` (с фильтрацией по датам)

### 3. Обработка данных в дашборде
**Файл:** `src/pages/EnhancedDashboard.tsx`
- `data?.attendance` → `attendanceMap` (useMemo)
- `attendanceMap` → используется в `dashboardDataTable` (useMemo)
- `dashboardDataTable` → используется для отображения в таблице

## Возможные проблемы

### Проблема 1: React Query кеширование
- `staleTime: 0` установлен, но может быть проблема с кешированием
- `refetchOnWindowFocus: true` и `refetchOnMount: true` установлены
- Но если компонент не размонтируется/монтируется, `refetchOnMount` не сработает

### Проблема 2: useMemo зависимости
- `attendanceMap` зависит от `data?.attendance` и `dataUpdatedAt`
- Если `data?.attendance` - это массив, React может не увидеть изменений, если ссылка не меняется
- `dataUpdatedAt` должен обновляться при каждом refetch

### Проблема 3: Фильтрация по датам
- `useDashboardData` фильтрует attendance по датам месяца
- Если новая запись создана с датой вне текущего месяца, она не появится
- Нужно проверить, что дата новой записи попадает в диапазон

### Проблема 4: Порядок операций
- `invalidateQueries` помечает данные как устаревшие
- `refetchQueries` должен перезапросить данные
- Но если компонент не активен, может не сработать

### Проблема 5: Изменения в коммите 07fd2d5
- Добавлена синхронизация скроллов через `tableScrollRefs`
- Добавлен `useEffect` с зависимостью `[days.length]`
- Возможно, что-то в этих изменениях влияет на обновление

## Вопросы для диагностики

1. **Обновляются ли данные в БД?**
   - Проверить в Supabase Dashboard, что новая запись attendance создана

2. **Вызывается ли refetch?**
   - Добавить логирование в `useDashboardData` queryFn

3. **Обновляется ли dataUpdatedAt?**
   - Добавить логирование `dataUpdatedAt` в компоненте

4. **Пересчитывается ли attendanceMap?**
   - Добавить логирование в useMemo для `attendanceMap`

5. **Попадает ли новая запись в запрос?**
   - Проверить, что дата новой записи попадает в диапазон `startDate` - `endDate`

6. **Обновляется ли компонент?**
   - Проверить, что React видит изменения в `data`

## План диагностики

1. Добавить логирование в:
   - `useSetAttendance.onSuccess` - проверить, что вызывается
   - `useDashboardData.queryFn` - проверить, что запрос выполняется
   - `attendanceMap` useMemo - проверить, что пересчитывается
   - Компонент дашборда - проверить, что `data` обновляется

2. Проверить в консоли браузера:
   - Вызывается ли `refetchQueries`
   - Обновляется ли `dataUpdatedAt`
   - Приходят ли новые данные из БД

3. Проверить в Supabase:
   - Создается ли запись в таблице `attendance`
   - Правильная ли дата у записи
   - Правильный ли `enrollment_id`

## Гипотезы

### Гипотеза 1: React Query не перезапрашивает данные
- `refetchQueries` вызывается, но запрос не выполняется
- Возможно, из-за кеширования или состояния запроса

### Гипотеза 2: Данные приходят, но не обрабатываются
- Запрос выполняется, данные приходят
- Но `attendanceMap` не пересчитывается из-за проблем с зависимостями

### Гипотеза 3: Данные обрабатываются, но не отображаются
- `attendanceMap` пересчитывается
- Но компонент не перерисовывается из-за проблем с React

### Гипотеза 4: Проблема с фильтрацией
- Новая запись создается, но не попадает в запрос из-за фильтрации
- Или попадает, но фильтруется на этапе обработки
